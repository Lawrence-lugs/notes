<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.555">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2026-01-12">

<title>Lawrence Roman A. Quizon - Solving Ballistics Equation with RK4 in C</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Lawrence Roman A. Quizon</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#forward-euler" id="toc-forward-euler" class="nav-link active" data-scroll-target="#forward-euler">Forward Euler</a></li>
  <li><a href="#plotting" id="toc-plotting" class="nav-link" data-scroll-target="#plotting">Plotting</a></li>
  <li><a href="#forward-euler-with-quadratic-drag" id="toc-forward-euler-with-quadratic-drag" class="nav-link" data-scroll-target="#forward-euler-with-quadratic-drag">Forward Euler with Quadratic Drag</a></li>
  <li><a href="#runge-kutta-4" id="toc-runge-kutta-4" class="nav-link" data-scroll-target="#runge-kutta-4">Runge-Kutta 4</a></li>
  <li><a href="#rk4-implementation" id="toc-rk4-implementation" class="nav-link" data-scroll-target="#rk4-implementation">RK4 implementation</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Solving Ballistics Equation with RK4 in C</h1>
</div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">January 12, 2026</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<div class="callout callout-style-default callout-note callout-titled" title="Questions">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Questions
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>How do we encode the ballistics equation in C?</li>
</ul>
</div>
</div>
<p>So the most basal ballistics equation is <span class="math display">\[\mathbf{F}=m\vec{a}\]</span></p>
<p>Then the vectors are <span class="math inline">\(\mathbf{F},x,y,\frac{dx}{dt},\frac{dy}{dt}\)</span>. The state vector <span class="math display">\[\vec{S}=\begin{bmatrix}
x\\y\\dx/dt\\dy/dt
\end{bmatrix}\]</span></p>
<section id="forward-euler" class="level1">
<h1>Forward Euler</h1>
<p><img src="attachments/Pasted image 20260115115215.png" class="img-fluid"> <span class="math display">\[\vec{S}_{n+1}=\mathbf{U}\vec{S_n}+\vec{F}\]</span> and since <span class="math inline">\(x_{n+1}=\Delta t \frac{dx}{dt}+x_n,y_{n+1}=\Delta t \frac{dy}{dt}+y_n,\)</span></p>
<p>The update matrix is <span class="math display">\[\mathbf{U}=\begin{bmatrix}
1 &amp; 0 &amp; dt &amp; 0 \\
0 &amp; 1 &amp; 0 &amp; dt \\
0 &amp; 0 &amp; 1 &amp; 0 \\
0 &amp; 0 &amp; 0 &amp; 1 \\
\end{bmatrix}, \vec{F}=\begin{bmatrix}
0 \\ 0 \\ 0 \\ -g\cdot dt
\end{bmatrix}\]</span></p>
<p>So first let’s try to make some vector-matrix working and test it out</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Not sure if it's a good idea to name these such a generic name</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co">// How do we handle other datatypes of vectors?</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> vector <span class="op">{</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> length<span class="op">;</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span><span class="op">*</span> elements<span class="op">;</span> </span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> vector_t<span class="op">;</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> matrix <span class="op">{</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> rows<span class="op">;</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> cols<span class="op">;</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span><span class="op">*</span> elements<span class="op">;</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> matrix_t<span class="op">;</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="co">// Any naming scheme for this to keep it local? </span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="co">// There aren't any classes in C, but I've heard </span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="co">// significant criticism of C++ anyway.</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> matrix_get_element <span class="op">(</span>matrix_t<span class="op">*</span> mat<span class="op">,</span> <span class="dt">int</span> i<span class="op">,</span> <span class="dt">int</span> j<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>i <span class="op">&gt;</span> mat<span class="op">-&gt;</span>rows <span class="op">||</span> j <span class="op">&gt;</span> mat<span class="op">-&gt;</span>cols<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Don't know standard practice in raising error.</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>        fprintf<span class="op">(</span>stderr<span class="op">,</span> <span class="st">"[matrix_get_element] (</span><span class="sc">%i</span><span class="st">,</span><span class="sc">%i</span><span class="st">) out of range. Exiting."</span><span class="op">,</span>i<span class="op">,</span>j<span class="op">);</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>        exit<span class="op">(</span>EXIT_FAILURE<span class="op">);</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> mat<span class="op">-&gt;</span>elements<span class="op">[</span>mat<span class="op">-&gt;</span>cols<span class="op">*</span>i <span class="op">+</span> j<span class="op">];</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> vector_print <span class="op">(</span>vector_t<span class="op">*</span> vec<span class="op">,</span> <span class="dt">char</span><span class="op">*</span> name<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> i<span class="op">;</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"</span><span class="sc">%s</span><span class="st"> &lt;</span><span class="sc">%zu</span><span class="st">&gt; : [</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span>name<span class="op">,</span>vec<span class="op">-&gt;</span>length<span class="op">);</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>i<span class="op">=</span><span class="dv">0</span><span class="op">;</span>i<span class="op">&lt;</span>vec<span class="op">-&gt;</span>length<span class="op">;</span>i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"  </span><span class="sc">%f</span><span class="st">,</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span>vec<span class="op">-&gt;</span>elements<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"]</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> matrix_print <span class="op">(</span>matrix_t<span class="op">*</span> mat<span class="op">,</span> <span class="dt">char</span><span class="op">*</span> name<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"</span><span class="sc">%s</span><span class="st"> &lt;</span><span class="sc">%zu</span><span class="st">,</span><span class="sc">%zu</span><span class="st">&gt;: [</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span>name<span class="op">,</span>mat<span class="op">-&gt;</span>rows<span class="op">,</span>mat<span class="op">-&gt;</span>cols<span class="op">);</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> mat<span class="op">-&gt;</span>rows<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> mat<span class="op">-&gt;</span>cols<span class="op">;</span> j<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>            printf<span class="op">(</span><span class="st">"  </span><span class="sc">%f</span><span class="st">,</span><span class="sc">\t</span><span class="st">"</span><span class="op">,</span>matrix_get_element<span class="op">(</span>mat<span class="op">,</span>i<span class="op">,</span>j<span class="op">));</span></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"]</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> matrix_vector_multiply <span class="op">(</span>vector_t<span class="op">*</span> res<span class="op">,</span> matrix_t <span class="op">*</span>mat<span class="op">,</span> vector_t<span class="op">*</span> vec<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>mat<span class="op">-&gt;</span>rows <span class="op">!=</span> vec<span class="op">-&gt;</span>length<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>        fprintf<span class="op">(</span>stderr<span class="op">,</span><span class="st">"mat rows != vector len! (</span><span class="sc">%zu</span><span class="st">!=</span><span class="sc">%zu</span><span class="st">)"</span><span class="op">,</span> mat<span class="op">-&gt;</span>rows<span class="op">,</span> vec<span class="op">-&gt;</span>length<span class="op">);</span></span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>        exit<span class="op">(</span>EXIT_FAILURE<span class="op">);</span></span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> i<span class="op">,</span>j<span class="op">;</span></span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span>i <span class="op">&lt;</span> res<span class="op">-&gt;</span>length<span class="op">;</span>i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>        res<span class="op">-&gt;</span>elements<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> <span class="fl">0.</span><span class="op">;</span></span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span>j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span>j <span class="op">&lt;</span> vec<span class="op">-&gt;</span>length<span class="op">;</span>j<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>            res<span class="op">-&gt;</span>elements<span class="op">[</span>i<span class="op">]</span> <span class="op">+=</span> vec<span class="op">-&gt;</span>elements<span class="op">[</span>j<span class="op">]</span> <span class="op">*</span> matrix_get_element<span class="op">(</span>mat<span class="op">,</span> i<span class="op">,</span> j<span class="op">);</span></span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>            <span class="co">//printf("[%f,%f]\n",vec-&gt;elements[j],matrix_get_element(mat, i, j));</span></span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>        <span class="op">};</span></span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> vector_add <span class="op">(</span>vector_t<span class="op">*</span> res<span class="op">,</span> vector_t<span class="op">*</span> veca<span class="op">,</span> vector_t<span class="op">*</span> vecb<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>veca<span class="op">-&gt;</span>length <span class="op">!=</span> vecb<span class="op">-&gt;</span>length<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a>        fprintf<span class="op">(</span>stderr<span class="op">,</span><span class="st">"vector length mismatch (</span><span class="sc">%zu</span><span class="st">!=</span><span class="sc">%zu</span><span class="st">)"</span><span class="op">,</span>veca<span class="op">-&gt;</span>length<span class="op">,</span>vecb<span class="op">-&gt;</span>length<span class="op">);</span></span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>        exit<span class="op">(</span>EXIT_FAILURE<span class="op">);</span></span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i<span class="op">=</span><span class="dv">0</span><span class="op">;</span> i<span class="op">&lt;</span>veca<span class="op">-&gt;</span>length<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a>        res<span class="op">-&gt;</span>elements<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> veca<span class="op">-&gt;</span>elements<span class="op">[</span>i<span class="op">]</span> <span class="op">+</span> vecb<span class="op">-&gt;</span>elements<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> sim_step <span class="op">(</span>vector_t<span class="op">*</span> next_state<span class="op">,</span> matrix_t<span class="op">*</span> update<span class="op">,</span> vector_t<span class="op">*</span> state<span class="op">,</span> vector_t<span class="op">*</span> force<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a>    matrix_vector_multiply<span class="op">(</span>next_state<span class="op">,</span>update<span class="op">,</span>state<span class="op">);</span></span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a>    vector_add<span class="op">(</span>state<span class="op">,</span>next_state<span class="op">,</span>force<span class="op">);</span></span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a>    <span class="co">//vector_print(state,"State");</span></span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> matrix_place_vector <span class="op">(</span>matrix_t<span class="op">*</span> mat<span class="op">,</span> vector_t<span class="op">*</span> vec<span class="op">,</span> <span class="dt">int</span> index<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>mat<span class="op">-&gt;</span>cols <span class="op">!=</span> vec<span class="op">-&gt;</span>length<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a>        fprintf<span class="op">(</span>stderr<span class="op">,</span><span class="st">"mat cols != vector len! (</span><span class="sc">%zu</span><span class="st">!=</span><span class="sc">%zu</span><span class="st">)"</span><span class="op">,</span> mat<span class="op">-&gt;</span>rows<span class="op">,</span> vec<span class="op">-&gt;</span>length<span class="op">);</span></span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a>        exit<span class="op">(</span>EXIT_FAILURE<span class="op">);</span></span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> j<span class="op">=</span><span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> vec<span class="op">-&gt;</span>length<span class="op">;</span> j<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a>        mat<span class="op">-&gt;</span>elements<span class="op">[</span>index<span class="op">*</span>mat<span class="op">-&gt;</span>cols <span class="op">+</span> j<span class="op">]</span> <span class="op">=</span> vec<span class="op">-&gt;</span>elements<span class="op">[</span>j<span class="op">];</span></span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">void</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a>    matrix_t update_matrix<span class="op">;</span></span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true" tabindex="-1"></a>    vector_t force_vector<span class="op">;</span></span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> dt<span class="op">=</span><span class="fl">1e-3</span><span class="op">;</span></span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> g<span class="op">=</span><span class="fl">9.81</span><span class="op">;</span></span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true" tabindex="-1"></a>    <span class="co">//float stop_time = 10; //seconds</span></span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> num_steps <span class="op">=</span> <span class="dv">500</span><span class="op">;</span> </span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Number of steps: </span><span class="sc">%i\n</span><span class="st">"</span><span class="op">,</span>num_steps<span class="op">);</span></span>
<span id="cb1-110"><a href="#cb1-110" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>num_steps <span class="op">&gt;</span> <span class="dv">1000</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"Warning: simulating more than 1000 steps.</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-113"><a href="#cb1-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-114"><a href="#cb1-114" aria-hidden="true" tabindex="-1"></a>    matrix_t result_matrix<span class="op">;</span></span>
<span id="cb1-115"><a href="#cb1-115" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> result_matrix_elements<span class="op">[</span>num_steps<span class="op">*</span><span class="dv">4</span><span class="op">];</span></span>
<span id="cb1-116"><a href="#cb1-116" aria-hidden="true" tabindex="-1"></a>    result_matrix<span class="op">.</span>cols <span class="op">=</span> <span class="dv">4</span><span class="op">;</span></span>
<span id="cb1-117"><a href="#cb1-117" aria-hidden="true" tabindex="-1"></a>    result_matrix<span class="op">.</span>rows <span class="op">=</span> num_steps<span class="op">;</span></span>
<span id="cb1-118"><a href="#cb1-118" aria-hidden="true" tabindex="-1"></a>    result_matrix<span class="op">.</span>elements <span class="op">=</span> result_matrix_elements<span class="op">;</span></span>
<span id="cb1-119"><a href="#cb1-119" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-120"><a href="#cb1-120" aria-hidden="true" tabindex="-1"></a>    vector_t state<span class="op">;</span></span>
<span id="cb1-121"><a href="#cb1-121" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> state_elements<span class="op">[</span><span class="dv">4</span><span class="op">]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb1-122"><a href="#cb1-122" aria-hidden="true" tabindex="-1"></a>        <span class="fl">0.</span><span class="op">,</span></span>
<span id="cb1-123"><a href="#cb1-123" aria-hidden="true" tabindex="-1"></a>        <span class="fl">0.</span><span class="op">,</span></span>
<span id="cb1-124"><a href="#cb1-124" aria-hidden="true" tabindex="-1"></a>        <span class="fl">1.</span><span class="op">,</span></span>
<span id="cb1-125"><a href="#cb1-125" aria-hidden="true" tabindex="-1"></a>        <span class="fl">1.</span></span>
<span id="cb1-126"><a href="#cb1-126" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb1-127"><a href="#cb1-127" aria-hidden="true" tabindex="-1"></a>    state<span class="op">.</span>length <span class="op">=</span> <span class="dv">4</span><span class="op">;</span></span>
<span id="cb1-128"><a href="#cb1-128" aria-hidden="true" tabindex="-1"></a>    state<span class="op">.</span>elements <span class="op">=</span> state_elements<span class="op">;</span></span>
<span id="cb1-129"><a href="#cb1-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-130"><a href="#cb1-130" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> update_matrix_elements<span class="op">[</span><span class="dv">4</span><span class="op">*</span><span class="dv">4</span><span class="op">]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb1-131"><a href="#cb1-131" aria-hidden="true" tabindex="-1"></a>        <span class="dv">1</span><span class="op">,</span>  <span class="dv">0</span><span class="op">,</span>  dt<span class="op">,</span>  <span class="dv">0</span> <span class="op">,</span></span>
<span id="cb1-132"><a href="#cb1-132" aria-hidden="true" tabindex="-1"></a>        <span class="dv">0</span><span class="op">,</span>  <span class="dv">1</span><span class="op">,</span>  <span class="dv">0</span> <span class="op">,</span>  dt<span class="op">,</span></span>
<span id="cb1-133"><a href="#cb1-133" aria-hidden="true" tabindex="-1"></a>        <span class="dv">0</span><span class="op">,</span>  <span class="dv">0</span><span class="op">,</span>  <span class="dv">1</span> <span class="op">,</span>  <span class="dv">0</span> <span class="op">,</span></span>
<span id="cb1-134"><a href="#cb1-134" aria-hidden="true" tabindex="-1"></a>        <span class="dv">0</span><span class="op">,</span>  <span class="dv">0</span><span class="op">,</span>  <span class="dv">0</span> <span class="op">,</span>  <span class="dv">1</span> <span class="op">,</span></span>
<span id="cb1-135"><a href="#cb1-135" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb1-136"><a href="#cb1-136" aria-hidden="true" tabindex="-1"></a>    update_matrix<span class="op">.</span>rows <span class="op">=</span> <span class="dv">4</span><span class="op">;</span></span>
<span id="cb1-137"><a href="#cb1-137" aria-hidden="true" tabindex="-1"></a>    update_matrix<span class="op">.</span>cols <span class="op">=</span> <span class="dv">4</span><span class="op">;</span></span>
<span id="cb1-138"><a href="#cb1-138" aria-hidden="true" tabindex="-1"></a>    update_matrix<span class="op">.</span>elements <span class="op">=</span> update_matrix_elements<span class="op">;</span></span>
<span id="cb1-139"><a href="#cb1-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-140"><a href="#cb1-140" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> force_vector_elements<span class="op">[</span><span class="dv">4</span><span class="op">]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb1-141"><a href="#cb1-141" aria-hidden="true" tabindex="-1"></a>        <span class="dv">0</span><span class="op">,</span></span>
<span id="cb1-142"><a href="#cb1-142" aria-hidden="true" tabindex="-1"></a>        <span class="dv">0</span><span class="op">,</span></span>
<span id="cb1-143"><a href="#cb1-143" aria-hidden="true" tabindex="-1"></a>        <span class="dv">0</span><span class="op">,</span></span>
<span id="cb1-144"><a href="#cb1-144" aria-hidden="true" tabindex="-1"></a>        <span class="op">-</span>g<span class="op">*</span>dt</span>
<span id="cb1-145"><a href="#cb1-145" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb1-146"><a href="#cb1-146" aria-hidden="true" tabindex="-1"></a>    force_vector<span class="op">.</span>length <span class="op">=</span> <span class="dv">4</span><span class="op">;</span></span>
<span id="cb1-147"><a href="#cb1-147" aria-hidden="true" tabindex="-1"></a>    force_vector<span class="op">.</span>elements <span class="op">=</span> force_vector_elements<span class="op">;</span></span>
<span id="cb1-148"><a href="#cb1-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-149"><a href="#cb1-149" aria-hidden="true" tabindex="-1"></a>    matrix_print<span class="op">(&amp;</span>update_matrix<span class="op">,</span> <span class="st">"Update Matrix"</span><span class="op">);</span></span>
<span id="cb1-150"><a href="#cb1-150" aria-hidden="true" tabindex="-1"></a>    vector_print<span class="op">(&amp;</span>force_vector<span class="op">,</span> <span class="st">"Force Vector"</span><span class="op">);</span></span>
<span id="cb1-151"><a href="#cb1-151" aria-hidden="true" tabindex="-1"></a>    vector_print<span class="op">(&amp;</span>state<span class="op">,</span><span class="st">"Initial State"</span><span class="op">);</span></span>
<span id="cb1-152"><a href="#cb1-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-153"><a href="#cb1-153" aria-hidden="true" tabindex="-1"></a>    vector_t next_state<span class="op">;</span></span>
<span id="cb1-154"><a href="#cb1-154" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> next_state_elements<span class="op">[</span><span class="dv">4</span><span class="op">];</span></span>
<span id="cb1-155"><a href="#cb1-155" aria-hidden="true" tabindex="-1"></a>    next_state<span class="op">.</span>elements <span class="op">=</span> next_state_elements<span class="op">;</span></span>
<span id="cb1-156"><a href="#cb1-156" aria-hidden="true" tabindex="-1"></a>    next_state<span class="op">.</span>length <span class="op">=</span> <span class="dv">4</span><span class="op">;</span></span>
<span id="cb1-157"><a href="#cb1-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-158"><a href="#cb1-158" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> step<span class="op">=</span><span class="dv">0</span><span class="op">;</span>step<span class="op">&lt;</span>num_steps<span class="op">;</span>step<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb1-159"><a href="#cb1-159" aria-hidden="true" tabindex="-1"></a>        sim_step<span class="op">(&amp;</span>next_state<span class="op">,&amp;</span>update_matrix<span class="op">,&amp;</span>state<span class="op">,&amp;</span>force_vector<span class="op">);</span></span>
<span id="cb1-160"><a href="#cb1-160" aria-hidden="true" tabindex="-1"></a>        matrix_place_vector<span class="op">(&amp;</span>result_matrix<span class="op">,&amp;</span>state<span class="op">,</span>step<span class="op">);</span></span>
<span id="cb1-161"><a href="#cb1-161" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-162"><a href="#cb1-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-163"><a href="#cb1-163" aria-hidden="true" tabindex="-1"></a>    matrix_print<span class="op">(&amp;</span>result_matrix<span class="op">,</span><span class="st">"Results"</span><span class="op">);</span></span>
<span id="cb1-164"><a href="#cb1-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-165"><a href="#cb1-165" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-default callout-tip callout-titled" title="Results">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Results
</div>
</div>
<div class="callout-body-container callout-body">
<p>Forward Euler always seems to overshoot the analytical solution. This is likely because we <em>reduce the velocity over time, but we calculate the change in position with the previous velocity.</em></p>
<p>So then, <span class="math inline">\(x_{n+1}=x_n+\Delta t v_n\)</span>.</p>
</div>
</div>
</section>
<section id="plotting" class="level1">
<h1>Plotting</h1>
<p>Plan: let’s just pass the matrix to matplotlib. An interactive plotting framework is nice to implement, but that’s not what we’re doing right now.</p>
<p>I implemented a pass between C and Python</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Nearly a general array</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> tensor_write_bin <span class="op">(</span><span class="dt">const</span> <span class="dt">char</span><span class="op">*</span> filename<span class="op">,</span> <span class="dt">const</span> Matrix<span class="op">*</span> mat<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">FILE</span><span class="op">*</span> file <span class="op">=</span> fopen<span class="op">(</span>filename<span class="op">,</span><span class="st">"wb"</span><span class="op">);</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>file<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>        fprintf<span class="op">(</span>stderr<span class="op">,</span> <span class="st">"Failed to open file."</span><span class="op">);</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Start file with ndims</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> ndims <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    fwrite<span class="op">(&amp;</span>ndims<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span><span class="dt">size_t</span><span class="op">),</span> <span class="dv">1</span><span class="op">,</span> file<span class="op">);</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// File starts with rows and cols</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    fwrite<span class="op">(&amp;</span>mat<span class="op">-&gt;</span>rows<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span><span class="dt">size_t</span><span class="op">),</span> <span class="dv">1</span><span class="op">,</span> file<span class="op">);</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    fwrite<span class="op">(&amp;</span>mat<span class="op">-&gt;</span>cols<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span><span class="dt">size_t</span><span class="op">),</span> <span class="dv">1</span><span class="op">,</span> file<span class="op">);</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Then, the payload</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> matBufferLength <span class="op">=</span> mat<span class="op">-&gt;</span>rows<span class="op">*</span>mat<span class="op">-&gt;</span>cols<span class="op">;</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    fwrite<span class="op">(</span>mat<span class="op">-&gt;</span>elements<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span><span class="dt">float</span><span class="op">),</span> matBufferLength<span class="op">,</span> file<span class="op">);</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> read_array_bin(filename):</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    size_t <span class="op">=</span> ctypes.sizeof(ctypes.c_size_t)<span class="op">;</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> size_t <span class="op">==</span> <span class="dv">4</span>:</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>        datatype <span class="op">=</span> np.uint32<span class="op">;</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>        datatype <span class="op">=</span> np.uint64<span class="op">;</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(filename,<span class="st">'rb'</span>) <span class="im">as</span> f:</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>        ndims <span class="op">=</span> np.fromfile(f,datatype,<span class="dv">1</span>)[<span class="dv">0</span>]<span class="op">;</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>        shape <span class="op">=</span> np.fromfile(f,datatype,ndims)<span class="op">;</span> </span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>        array <span class="op">=</span> np.fromfile(f,np.float32,<span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> array.reshape(shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Then we use the matplotlib animations library to animate it:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>    res_array <span class="op">=</span> read_array_bin(args.input_file)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(res_array)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    x_pos <span class="op">=</span> res_array[<span class="dv">0</span>]</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    y_pos <span class="op">=</span> res_array[<span class="dv">1</span>]</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    line <span class="op">=</span> ax.plot(x_pos[<span class="dv">0</span>], y_pos[<span class="dv">0</span>], label<span class="op">=</span><span class="ss">f'Trajectory'</span>)[<span class="dv">0</span>]</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    ax.<span class="bu">set</span>(xlim<span class="op">=</span>[<span class="dv">0</span>,<span class="dv">20</span>],ylim<span class="op">=</span>[<span class="op">-</span><span class="fl">5.5</span>,<span class="fl">5.5</span>],xlabel<span class="op">=</span><span class="st">'x'</span>, ylabel<span class="op">=</span><span class="st">'y'</span>)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    ax.legend()</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> update(frame):</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> x_pos[:frame]</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>        y <span class="op">=</span> y_pos[:frame]</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>        line.set_xdata(x)</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>        line.set_ydata(y)</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (line,line)</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>    dt <span class="op">=</span> <span class="fl">5e-3</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    frames <span class="op">=</span> res_array.shape[<span class="dv">1</span>] <span class="co"># Total number of frames</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>    interval <span class="op">=</span> dt <span class="co"># Delay between frames</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>    ani <span class="op">=</span> animation.FuncAnimation(fig<span class="op">=</span>fig, func<span class="op">=</span>update, frames<span class="op">=</span>frames, interval<span class="op">=</span>dt)</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>    fps <span class="op">=</span> <span class="bu">int</span>(<span class="dv">1</span><span class="op">/</span>dt)</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>    ani.save(<span class="ss">f'</span><span class="sc">{</span>filename<span class="sc">}</span><span class="ss">.gif'</span>,fps<span class="op">=</span><span class="dv">60</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="attachments/forwardEuler.gif" class="lightbox" data-gallery="quarto-lightbox-gallery-1" data-glightbox="description: .lightbox-desc-1" title="Trajectory without drag"><img src="attachments/forwardEuler.gif" class="img-fluid figure-img" alt="Trajectory without drag"></a></p>
<figcaption>Trajectory without drag</figcaption>
</figure>
</div>
</section>
<section id="forward-euler-with-quadratic-drag" class="level1">
<h1>Forward Euler with Quadratic Drag</h1>
<p>The quadratic drag equation has (mostly) no analytical solutions.</p>
<p>With drag, a force proportional to the square of the velocity develops opposing the direction of the velocity: <span class="math display">\[\vec{F}=-k|\vec{v}|\vec{v}\]</span> The update matrix turns into: <span class="math display">\[\mathbf{U}=\begin{bmatrix}
1 &amp; 0 &amp; dt &amp; 0 \\
0 &amp; 1 &amp; 0 &amp; dt \\
0 &amp; 0 &amp; 1-k|v| &amp; 0 \\
0 &amp; 0 &amp; 0 &amp; 1-k|v| \\
\end{bmatrix}, \vec{F}=\begin{bmatrix}
0 \\ 0 \\ 0 \\ -g\cdot dt
\end{bmatrix}\]</span></p>
<p>To implement drag, we also update the update matrix every time step:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> get_update_matrix <span class="op">(</span>Matrix<span class="op">*</span> upd<span class="op">,</span><span class="dt">const</span> Vector<span class="op">*</span> state<span class="op">,</span><span class="dt">const</span> <span class="dt">float</span> dt<span class="op">,</span> <span class="dt">const</span> <span class="dt">float</span> drag_constant<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> x <span class="op">=</span> state<span class="op">-&gt;</span>elements<span class="op">[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> y <span class="op">=</span> state<span class="op">-&gt;</span>elements<span class="op">[</span><span class="dv">1</span><span class="op">];</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> vx <span class="op">=</span> state<span class="op">-&gt;</span>elements<span class="op">[</span><span class="dv">2</span><span class="op">];</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> vy <span class="op">=</span> state<span class="op">-&gt;</span>elements<span class="op">[</span><span class="dv">3</span><span class="op">];</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> speed <span class="op">=</span> sqrtf<span class="op">(</span>vx<span class="op">*</span>vx <span class="op">+</span> vy<span class="op">*</span>vy<span class="op">);</span> </span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> drag <span class="op">=</span> speed<span class="op">*</span>drag_constant<span class="op">;</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> updated_elements<span class="op">[</span><span class="dv">4</span><span class="op">*</span><span class="dv">4</span><span class="op">]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>        <span class="dv">1</span><span class="op">,</span>  <span class="dv">0</span><span class="op">,</span>  dt     <span class="op">,</span>  <span class="dv">0</span>      <span class="op">,</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>        <span class="dv">0</span><span class="op">,</span>  <span class="dv">1</span><span class="op">,</span>  <span class="dv">0</span>      <span class="op">,</span>  dt     <span class="op">,</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>        <span class="dv">0</span><span class="op">,</span>  <span class="dv">0</span><span class="op">,</span>  <span class="dv">1</span><span class="op">-</span>drag <span class="op">,</span>  <span class="dv">0</span>      <span class="op">,</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>        <span class="dv">0</span><span class="op">,</span>  <span class="dv">0</span><span class="op">,</span>  <span class="dv">0</span>      <span class="op">,</span>  <span class="dv">1</span><span class="op">-</span>drag <span class="op">,</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    memcpy<span class="op">(</span>upd<span class="op">-&gt;</span>elements<span class="op">,</span> updated_elements<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>updated_elements<span class="op">));</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="attachments/forwardEuler 2.gif" class="lightbox" data-gallery="quarto-lightbox-gallery-2" data-glightbox="description: .lightbox-desc-2" title="Forward Euler with Drag"><img src="attachments/forwardEuler 2.gif" class="img-fluid figure-img" alt="Forward Euler with Drag"></a></p>
<figcaption>Forward Euler with Drag</figcaption>
</figure>
</div>
<p>Notice that with quadratic drag, the system is now nonlinear and the “update matrix” no longer makes sense (it’s a function of the state vector it’s operating on, so it’s not linear). We can replace the matrix stuff with a generic update of the state:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> sim_step <span class="op">(</span>Vector<span class="op">*</span> state<span class="op">,</span><span class="dt">const</span> Vector<span class="op">*</span> force<span class="op">,</span> <span class="dt">const</span> <span class="dt">float</span> dt<span class="op">,</span> <span class="dt">const</span> <span class="dt">float</span> drag_per_mass<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> x <span class="op">=</span> state<span class="op">-&gt;</span>elements<span class="op">[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> y <span class="op">=</span> state<span class="op">-&gt;</span>elements<span class="op">[</span><span class="dv">1</span><span class="op">];</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> vx <span class="op">=</span> state<span class="op">-&gt;</span>elements<span class="op">[</span><span class="dv">2</span><span class="op">];</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> vy <span class="op">=</span> state<span class="op">-&gt;</span>elements<span class="op">[</span><span class="dv">3</span><span class="op">];</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> speed <span class="op">=</span> sqrtf<span class="op">(</span>vx<span class="op">*</span>vx <span class="op">+</span> vy<span class="op">*</span>vy<span class="op">);</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> dx <span class="op">=</span> vx<span class="op">;</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> dy <span class="op">=</span> vy<span class="op">;</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> dvx <span class="op">=</span> vx<span class="op">*(-</span>speed<span class="op">*</span>drag_per_mass<span class="op">)</span> <span class="op">+</span> force<span class="op">-&gt;</span>elements<span class="op">[</span><span class="dv">2</span><span class="op">];</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> dvy <span class="op">=</span> vy<span class="op">*(-</span>speed<span class="op">*</span>drag_per_mass<span class="op">)</span> <span class="op">+</span> force<span class="op">-&gt;</span>elements<span class="op">[</span><span class="dv">3</span><span class="op">];</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    state<span class="op">-&gt;</span>elements<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> x <span class="op">+</span> dt<span class="op">*</span>dx<span class="op">;</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    state<span class="op">-&gt;</span>elements<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">=</span> y <span class="op">+</span> dt<span class="op">*</span>dy<span class="op">;</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>    state<span class="op">-&gt;</span>elements<span class="op">[</span><span class="dv">2</span><span class="op">]</span> <span class="op">=</span> vx <span class="op">+</span> dt<span class="op">*</span>dvx<span class="op">;</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    state<span class="op">-&gt;</span>elements<span class="op">[</span><span class="dv">3</span><span class="op">]</span> <span class="op">=</span> vy <span class="op">+</span> dt<span class="op">*</span>dvy<span class="op">;</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="runge-kutta-4" class="level1">
<h1>Runge-Kutta 4</h1>
<p>Forward euler is technically RK1. The 4 means we approximate the correct average slope over the time step with 4 different estimates.</p>
<div class="callout callout-style-default callout-tip callout-titled" title="[Runge-Kutta](https://en.wikipedia.org/wiki/Runge%E2%80%93Kutta_methods)">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<a href="https://en.wikipedia.org/wiki/Runge%E2%80%93Kutta_methods">Runge-Kutta</a>
</div>
</div>
<div class="callout-body-container callout-body">
<p>Given a problem in the following form: <span class="math display">\[\frac{dy}{dt}=f(t,y), y(t_0)=y_0\]</span> RK4 gives an estimate of <span class="math inline">\(\frac{dy}{dt}\)</span> using a weighted average of four slopes <span class="math inline">\(f(t,y)\)</span> <span class="math inline">\(k_1\)</span> to <span class="math inline">\(k_4\)</span> in the “future” of the current point in time Choosing a time step <span class="math inline">\(\Delta t&gt;0\)</span> <span class="math display">\[y_{n+1}=y_n+\frac{\Delta t}{6}(k_1+2k_2+2k_3+k_4)\]</span> <span class="math display">\[t_{n+1}=t_n+\Delta t\]</span> <span class="math display">\[k_1=f(t_n,y_n),\]</span> <span class="math display">\[k_2=f(t_n+\frac{\Delta t}{2},y_n+\Delta t\frac{k_1}{2})\]</span> <span class="math display">\[k_3=f(t_n+\frac{\Delta t}{2},y_n+\Delta t\frac{k_2}{2})\]</span> <span class="math display">\[k_4=f(t_n+\Delta t,y_n+\Delta tk_3)\]</span></p>
</div>
</div>
<p>If the forward euler equation for <span class="math inline">\(v_y\)</span> is <span class="math display">\[v_{y,t+1}=f(t_n,v_y)=v_{y,t} -g\Delta t-k|\vec{v}|v_{y,t}\]</span> Then the RK4 estimates would be <span class="math display">\[k_1=v_{y,t} (1-k|\vec{v}|) -g\Delta t\]</span> <span class="math display">\[k_2=(v_{y,t}+\frac{\Delta tk_1}{2}) (1-k|\vec{v}(\frac{\Delta tk_1}{2})|) -g\frac{3\Delta t}{2}\]</span> <span class="math display">\[k_3=(v_{y,t}+\frac{\Delta tk_2}{2}) (1-k|\vec{v}(\frac{\Delta tk_2}{2})|) -g\frac{3\Delta t}{2}\]</span> <span class="math display">\[k_4=(v_{y,t}+\Delta tk_3) (1-k|\vec{v}(\Delta tk_3)|) -g2\Delta t\]</span></p>
</section>
<section id="rk4-implementation" class="level1">
<h1>RK4 implementation</h1>
<p>The most important part of the RK4 implementation has to be the <code>get_slope</code> function refactor</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> get_slope<span class="op">(</span><span class="dt">const</span> Vector<span class="op">*</span> slope<span class="op">,</span>Vector<span class="op">*</span> state<span class="op">,</span><span class="dt">const</span> Vector<span class="op">*</span> force<span class="op">,</span> <span class="dt">const</span> <span class="dt">float</span> drag_per_mass<span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> vx <span class="op">=</span> state<span class="op">-&gt;</span>elements<span class="op">[</span><span class="dv">2</span><span class="op">];</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> vy <span class="op">=</span> state<span class="op">-&gt;</span>elements<span class="op">[</span><span class="dv">3</span><span class="op">];</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> speed <span class="op">=</span> sqrtf<span class="op">(</span>vx<span class="op">*</span>vx <span class="op">+</span> vy<span class="op">*</span>vy<span class="op">);</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    slope<span class="op">-&gt;</span>elements<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> vx<span class="op">;</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    slope<span class="op">-&gt;</span>elements<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">=</span> vy<span class="op">;</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    slope<span class="op">-&gt;</span>elements<span class="op">[</span><span class="dv">2</span><span class="op">]</span> <span class="op">=</span> vx<span class="op">*(-</span>speed<span class="op">*</span>drag_per_mass<span class="op">)</span> <span class="op">+</span> force<span class="op">-&gt;</span>elements<span class="op">[</span><span class="dv">2</span><span class="op">];</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    slope<span class="op">-&gt;</span>elements<span class="op">[</span><span class="dv">3</span><span class="op">]</span> <span class="op">=</span> vy<span class="op">*(-</span>speed<span class="op">*</span>drag_per_mass<span class="op">)</span> <span class="op">+</span> force<span class="op">-&gt;</span>elements<span class="op">[</span><span class="dv">3</span><span class="op">];</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>and the accompanying changes in the way we step the simulation</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> sim_step<span class="op">(</span>Vector<span class="op">*</span> state<span class="op">,</span><span class="dt">const</span> Vector<span class="op">*</span> force<span class="op">,</span> <span class="dt">const</span> <span class="dt">float</span> dt<span class="op">,</span> <span class="dt">const</span> <span class="dt">float</span> drag_per_mass<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    Vector slope <span class="op">=</span> <span class="op">{</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>elements <span class="op">=</span> <span class="op">(</span><span class="dt">float</span><span class="op">[</span><span class="dv">4</span><span class="op">]){},</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>length <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    get_slope<span class="op">(&amp;</span>slope<span class="op">,</span> state<span class="op">,</span> force<span class="op">,</span> drag_per_mass<span class="op">);</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    vector_scalar_multiply<span class="op">(</span>dt<span class="op">,</span> <span class="op">&amp;</span>slope<span class="op">);</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    vector_add<span class="op">(</span>state<span class="op">,</span> state<span class="op">,</span> <span class="op">&amp;</span>slope<span class="op">);</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>with this, it’s easy to add RK4 by just chaining the calls to <code>get_slope</code> in order to use previous RK estimates for the next ones.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>    get_slope<span class="op">(&amp;</span>k1<span class="op">,</span> state<span class="op">,</span> force<span class="op">,</span> drag_per_mass<span class="op">);</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    vector_scalar_multiply_copy<span class="op">(&amp;</span>scratch<span class="op">,</span><span class="fl">0.5</span><span class="op">*</span>dt<span class="op">,</span> <span class="op">&amp;</span>k1<span class="op">);</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    vector_add<span class="op">(&amp;</span>scratch<span class="op">,</span> state<span class="op">,</span> <span class="op">&amp;</span>scratch<span class="op">);</span> <span class="co">// State + 0.5*dt*k1;</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    get_slope<span class="op">(&amp;</span>k2<span class="op">,</span> <span class="op">&amp;</span>scratch<span class="op">,</span> force<span class="op">,</span> drag_per_mass<span class="op">);</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    vector_scalar_multiply_copy<span class="op">(&amp;</span>scratch<span class="op">,</span><span class="fl">0.5</span><span class="op">*</span>dt<span class="op">,</span> <span class="op">&amp;</span>k2<span class="op">);</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    vector_add<span class="op">(&amp;</span>scratch<span class="op">,</span> state<span class="op">,</span> <span class="op">&amp;</span>scratch<span class="op">);</span> <span class="co">// State + 0.5*dt*k2;</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    get_slope<span class="op">(&amp;</span>k3<span class="op">,</span> <span class="op">&amp;</span>scratch<span class="op">,</span> force<span class="op">,</span> drag_per_mass<span class="op">);</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    vector_scalar_multiply_copy<span class="op">(&amp;</span>scratch<span class="op">,</span>dt<span class="op">,</span> <span class="op">&amp;</span>k3<span class="op">);</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    vector_add<span class="op">(&amp;</span>scratch<span class="op">,</span> state<span class="op">,</span> <span class="op">&amp;</span>scratch<span class="op">);</span> <span class="co">// State + dt*k3;</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    get_slope<span class="op">(&amp;</span>k4<span class="op">,</span> <span class="op">&amp;</span>scratch<span class="op">,</span> force<span class="op">,</span> drag_per_mass<span class="op">);</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    vector_scalar_multiply<span class="op">(</span><span class="dv">2</span><span class="op">,&amp;</span>k2<span class="op">);</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    vector_scalar_multiply<span class="op">(</span><span class="dv">2</span><span class="op">,&amp;</span>k3<span class="op">);</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>    vector_add<span class="op">(&amp;</span>slope<span class="op">,</span> <span class="op">&amp;</span>k1<span class="op">,</span> <span class="op">&amp;</span>k2<span class="op">);</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>    vector_add<span class="op">(&amp;</span>slope<span class="op">,</span> <span class="op">&amp;</span>slope<span class="op">,</span> <span class="op">&amp;</span>k3<span class="op">);</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>    vector_add<span class="op">(&amp;</span>slope<span class="op">,</span> <span class="op">&amp;</span>slope<span class="op">,</span> <span class="op">&amp;</span>k4<span class="op">);</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>    vector_scalar_multiply<span class="op">(</span>dt<span class="op">/</span><span class="dv">6</span><span class="op">,</span> <span class="op">&amp;</span>slope<span class="op">);</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>    vector_add<span class="op">(</span>state<span class="op">,</span> state<span class="op">,</span> <span class="op">&amp;</span>slope<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Here’s the comparison of RK4 with a refactored and better version of the forwardEuler.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>More specifically, in the new forwardEuler the drag constant doesn’t include <code>dt</code> in it by accident, and it’s easier to track its effect.</p>
<p>This had to be done so that we can see how the sims behave with the same drag coefficient.</p>
</div>
</div>
<p><a href="attachments/trajectories.gif" class="lightbox" data-gallery="quarto-lightbox-gallery-3"><img src="attachments/trajectories.gif" class="img-fluid"></a></p>
<p>We were promised that RK4 follows the real thing better, and it does here.</p>
<p>We know from the initial sims that Forward Euler tends to overshoot when all you do is reduce the velocity (which is what drag and gravity does). Here, we see that RK4 undershoots the Euler estimate- which means it doesn’t have the same overshoot.</p>


<div class="hidden" aria-hidden="true">
<span class="glightbox-desc lightbox-desc-1">Trajectory without drag</span>
<span class="glightbox-desc lightbox-desc-2">Forward Euler with Drag</span>
</div>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","openEffect":"zoom","loop":false,"descPosition":"bottom","selector":".lightbox"});
window.onload = () => {
  lightboxQuarto.on('slide_before_load', (data) => {
    const { slideIndex, slideNode, slideConfig, player, trigger } = data;
    const href = trigger.getAttribute('href');
    if (href !== null) {
      const imgEl = window.document.querySelector(`a[href="${href}"] img`);
      if (imgEl !== null) {
        const srcAttr = imgEl.getAttribute("src");
        if (srcAttr && srcAttr.startsWith("data:")) {
          slideConfig.href = srcAttr;
        }
      }
    } 
  });

  lightboxQuarto.on('slide_after_load', (data) => {
    const { slideIndex, slideNode, slideConfig, player, trigger } = data;
    if (window.Quarto?.typesetMath) {
      window.Quarto.typesetMath(slideNode);
    }
  });

};
          </script>




</body></html>